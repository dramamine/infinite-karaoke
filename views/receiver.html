<html>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <head>
    <title>Karaoke - Remote</title>
  </head>
  <body>
    <div class="container">
      <h1>Karaoke - Remote</h1>
      <h3> - </h3>
      <div class="row">
        <div class="span5 offset1">
          <div id="ytplayer"></div>
        </div>
        <div class="span3 offset6">
          <p id="lyricsbox"></p>
        </div>
      </div>
    </div>

    <DIV id="message">Talk to me</DIV>


    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
    <script type="text/javascript">
      window.onload = function() {
        cast.receiver.logger.setLevelValue(0);
        window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
        console.log('Starting Receiver Manager');
        
        // handler for the 'ready' event
        castReceiverManager.onReady = function(event) {
          console.log('Received Ready event: ' + JSON.stringify(event.data));
          window.castReceiverManager.setApplicationState("Application status is ready...");
        };
        
        // handler for 'senderconnected' event
        castReceiverManager.onSenderConnected = function(event) {
          console.log('Received Sender Connected event: ' + event.data);
          console.log(window.castReceiverManager.getSender(event.data).userAgent);
        };
        
        // handler for 'senderdisconnected' event
        castReceiverManager.onSenderDisconnected = function(event) {
          console.log('Received Sender Disconnected event: ' + event.data);
          if (window.castReceiverManager.getSenders().length == 0) {
          window.close();
        }
        };
        
        // handler for 'systemvolumechanged' event
        castReceiverManager.onSystemVolumeChanged = function(event) {
          console.log('Received System Volume Changed event: ' + event.data['level'] + ' ' +
              event.data['muted']);
        };

        // create a CastMessageBus to handle messages for a custom namespace
        window.messageBus =
          window.castReceiverManager.getCastMessageBus(
              'urn:x-cast:com.mylifeismetal.karaoke');

        // handler for the CastMessageBus message event
        window.messageBus.onMessage = function(event) {
          console.log('Message [' + event.senderId + ']: ' + event.data);
          // display the message from the sender
          displayText(event.data);
          // inform all senders on the CastMessageBus of the incoming message event
          // sender message listener will be invoked
          window.messageBus.send(event.senderId, event.data);
        }

        // initialize the CastReceiverManager with an application status message
        window.castReceiverManager.start({statusText: "Application is starting"});
        console.log('Receiver Manager started');
      };
      
      // utility function to display the text message in the input field
      function displayText(text) {
        console.log(text);
        document.getElementById("message").innerHTML=text;
        window.castReceiverManager.setApplicationState(text);
      };
    </script>
  </body>

<script type="text/javascript">
var videoId = '';
var timing = [ ];
var lyrics = [ ];

// this solution sucks but will have to do for now
var waitingForData = false;

function receiveData(data) {
  console.log("received data!");

  // TODO dynamic
  // this.videoId = data.youtubeid
  this.videoId = data.youtubeid;
  this.timing = data.timing;
  this.lyrics = data.lyrics;

  // start kicking off some things
  // Load the IFrame Player API code asynchronously.
  
  if( this.waitingForData ) this.onYouTubePlayerAPIReady();

}

var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// Replace the 'ytplayer' element with an <iframe> and
// YouTube player after the API code downloads.
var player;
function onYouTubePlayerAPIReady() {

  // this solution will have to do for now
  if( videoId === '' )
  {
    this.waitingForData = true;
    return;
  }

  player = new YT.Player('ytplayer', {
    height: '390',
    width: '640',
    videoId: videoId,
    origin: '//localhost:4567', // TODO update this for production
    events: {
    'onReady': onPlayerReady,
    'onStateChange': onPlayerStateChange
    }
  });
  console.log("youtube iframe ready!");
}


// insert timing and lyrics here...
//console.log( {{lyrics}} );
// TODO make this 0
// 

// var timing = [ 20, 3660, 6000 ];
// var lyrics = [ "intro", "zone 4", "get money" ];



var lyricsIndex = 1;
var timer = null;
var offset = 0;

function onPlayerReady(event) {
  console.log("player ready!");
  
  $('.lyricsdiv .times').each(function(item){
    timing.push( parseInt( $(this).text() ) );
    console.log("pushed " + $(this).text());
  });
  $('.lyricsdiv .lines').each(function(item){
    lyrics.push( $(this).text() );
  });

  event.target.playVideo();
      };

function onPlayerStateChange(event) {
  console.log("state changed:" + event.data);

  if (event.data == YT.PlayerState.PLAYING) {

    flashCurrentLyric();

  }
  if (event.data == YT.PlayerState.PAUSED) {
    clearInterval(timer);
  }
};


// just run flash every time the player starts
function flashCurrentLyric() 
{
  var currentTime = player.getCurrentTime() * 1000;
  // look through the array for what lyric should be playing
  var currentLyricFrame = timing.length-1;
  for (var i = 0; i < timing.length; i++) {
    if ( (timing[i] + offset) > currentTime )
    {
      console.log("found time " + timing[i] + " + offset " + offset +  " was greater than current time " + currentTime)
      // previous (or first) frame
      currentLyricFrame = (i > 0)? i-1 : 0;
      break;
    }
  };

  flashLyric(currentLyricFrame, currentTime);

}

// putting this here for now, to keep var in scope
var nextIndex;
function flashLyric(index, currentTime)
{
  if (currentTime == null) currentTime = player.getCurrentTime() * 1000;
  // update page
  $('#lyricsbox').text( lyrics[index] );

  // queue next lyric, if it's not the final frame
  if( index != timing.length - 1 )
  {
    var nextQueueTime = timing[ index + 1 ] + offset;
    var delay = nextQueueTime - currentTime;
    nextIndex = index + 1;
    timer = setTimeout( 
      function(){
        flashLyric(nextIndex);
      },
    delay);
  }

}

function updateOffset()
{
  // TODO might want to restrict this box to integers only
  offset = parseInt( $('#offset').val() );
  flashCurrentLyric();
}


$(document).ready(function(){
  console.log("doc ready!");


});
</script>

</html>